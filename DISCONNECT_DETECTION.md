# æœåŠ¡å™¨æ–­å¼€è¿æ¥æ£€æµ‹åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

å½“æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€è¿æ¥æˆ–ç½‘ç»œä¸­æ–­æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šç«‹å³æ£€æµ‹åˆ°è¿™ä¸€æƒ…å†µï¼Œå‘ç”¨æˆ·æ˜¾ç¤ºæé†’ä¿¡æ¯ï¼Œå¹¶è‡ªåŠ¨æ¸…ç†èµ„æºåé€€å‡ºç¨‹åºã€‚

**åŠŸèƒ½äº®ç‚¹**ï¼š
- âœ… å®æ—¶æ£€æµ‹æœåŠ¡å™¨è¿æ¥çŠ¶æ€
- âœ… çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€å…±äº«
- âœ… ç”¨æˆ·å‹å¥½çš„æç¤ºä¿¡æ¯
- âœ… ä¼˜é›…çš„èµ„æºæ¸…ç†
- âœ… è‡ªåŠ¨é€€å‡ºï¼ˆæ— éœ€ç”¨æˆ·å¹²é¢„ï¼‰

---

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒæœºåˆ¶

ä½¿ç”¨ä¸¤ä¸ªå…¨å±€å˜é‡å®ç°è¿æ¥çŠ¶æ€åŒæ­¥ï¼š

```c
// è¿æ¥çŠ¶æ€æ ‡å¿—
volatile int connection_closed = 0;  // 0=è¿æ¥ä¸­ï¼Œ1=è¿æ¥å·²æ–­å¼€

// ä¿æŠ¤æ ‡å¿—çš„äº’æ–¥é”
pthread_mutex_t connection_mutex = PTHREAD_MUTEX_INITIALIZER;
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ `volatile`ï¼Ÿ**
- é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–æ‰é‡å¤æ£€æŸ¥
- ç¡®ä¿æ¯æ¬¡éƒ½ä»å†…å­˜è¯»å–æœ€æ–°å€¼

**ä¸ºä»€ä¹ˆä½¿ç”¨äº’æ–¥é”ï¼Ÿ**
- é˜²æ­¢ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹/è¯»å–æ ‡å¿—
- é¿å…ç«æ€æ¡ä»¶

### æ‰§è¡Œæµç¨‹

#### 1. æ¥æ”¶çº¿ç¨‹ï¼ˆreceive_messagesï¼‰

```c
while ((len = recv(sockfd, buffer, BUFFER_SIZE, 0)) > 0) {
    // æ­£å¸¸æ¥æ”¶æ¶ˆæ¯
    buffer[len] = '\0';
    printf("%s\n", buffer);
}

// æ£€æŸ¥æ¥æ”¶ç»“æœ
if (len == 0) {
    // æœåŠ¡å™¨ä¸»åŠ¨å…³é—­è¿æ¥
    printf("\nâŒ æœåŠ¡å™¨å·²æ–­å¼€è¿æ¥ï¼\n");
} else if (len < 0) {
    // æ¥æ”¶é”™è¯¯ï¼ˆç½‘ç»œä¸­æ–­ç­‰ï¼‰
    perror("âŒ æ¥æ”¶æ•°æ®å¤±è´¥");
}

// è®¾ç½®è¿æ¥æ–­å¼€æ ‡å¿—
pthread_mutex_lock(&connection_mutex);
connection_closed = 1;
pthread_mutex_unlock(&connection_mutex);

printf("ğŸ’¤ ç¨‹åºå³å°†é€€å‡º...\n");
```

**recv() è¿”å›å€¼è¯´æ˜**ï¼š
- `> 0`ï¼šæ¥æ”¶åˆ°æ•°æ®çš„å­—èŠ‚æ•°
- `= 0`ï¼šè¿æ¥è¢«å¯¹æ–¹å…³é—­
- `< 0`ï¼šå‡ºç°é”™è¯¯

#### 2. ä¸»çº¿ç¨‹ï¼ˆè¾“å…¥å¾ªç¯ï¼‰

```c
while (1) {
    // æ£€æŸ¥è¿æ¥æ˜¯å¦å·²æ–­å¼€
    pthread_mutex_lock(&connection_mutex);
    if (connection_closed) {
        pthread_mutex_unlock(&connection_mutex);
        break;  // é€€å‡ºå¾ªç¯
    }
    pthread_mutex_unlock(&connection_mutex);
    
    // ç»§ç»­æ¥æ”¶ç”¨æˆ·è¾“å…¥...
    fgets(buf, BUFFER_SIZE, stdin);
    // ...
}
```

**æ£€æŸ¥é¢‘ç‡**ï¼šæ¯æ¬¡è·å–ç”¨æˆ·è¾“å…¥å‰éƒ½æ£€æŸ¥ä¸€æ¬¡

---

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæœåŠ¡å™¨æ­£å¸¸å…³é—­
```
å®¢æˆ·ç«¯è¾“å‡ºï¼š
âŒ æœåŠ¡å™¨å·²æ–­å¼€è¿æ¥ï¼
ğŸ’¤ ç¨‹åºå³å°†é€€å‡º...
[ç¨‹åºè‡ªåŠ¨é€€å‡º]
```

### åœºæ™¯2ï¼šç½‘ç»œä¸­æ–­
```
å®¢æˆ·ç«¯è¾“å‡ºï¼š
âŒ æ¥æ”¶æ•°æ®å¤±è´¥: Connection reset by peer
ğŸ’¤ ç¨‹åºå³å°†é€€å‡º...
[ç¨‹åºè‡ªåŠ¨é€€å‡º]
```

### åœºæ™¯3ï¼šå®¢æˆ·ç«¯åœ¨è¾“å…¥æ—¶æœåŠ¡å™¨æ–­å¼€
```
å®¢æˆ·ç«¯è¾“å‡ºï¼š
[ç”¨æˆ·æ­£åœ¨è¾“å…¥...ä»»ä½•æ—¶åˆ»æœåŠ¡å™¨æ–­å¼€]
âŒ æœåŠ¡å™¨å·²æ–­å¼€è¿æ¥ï¼
ğŸ’¤ ç¨‹åºå³å°†é€€å‡º...
[ç¨‹åºè‡ªåŠ¨é€€å‡º]
```

---

## æµ‹è¯•åŠŸèƒ½

### è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•

```bash
cd /home/chasen/lcz/learn_linux/linuxåº”ç”¨å¼€å‘/class/SimpleChat_CS
./test_disconnect.sh
```

**æµ‹è¯•æµç¨‹**ï¼š
1. å¯åŠ¨æœåŠ¡å™¨
2. å¯åŠ¨å®¢æˆ·ç«¯
3. å‘é€å‡ æ¡æ¶ˆæ¯
4. æœåŠ¡å™¨è¢«æ€æ­»
5. å®¢æˆ·ç«¯åº”æ˜¾ç¤ºæ–­å¼€è¿æ¥æç¤ºå¹¶è‡ªåŠ¨é€€å‡º

**æœŸæœ›è¾“å‡º**ï¼š
```
âŒ æœåŠ¡å™¨å·²æ–­å¼€è¿æ¥ï¼
ğŸ’¤ ç¨‹åºå³å°†é€€å‡º...
```

### æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

**ç»ˆç«¯1 - å¯åŠ¨æœåŠ¡å™¨**ï¼š
```bash
./server/server
```

**ç»ˆç«¯2 - å¯åŠ¨å®¢æˆ·ç«¯**ï¼š
```bash
./client/client
```

**ç»ˆç«¯1 - æ€æ­»æœåŠ¡å™¨**ï¼š
æŒ‰ `Ctrl+C` æˆ–è¿è¡Œ `kill <server_pid>`

**è§‚å¯Ÿç»ˆç«¯2**ï¼š
åº”è¯¥çœ‹åˆ°æ–­å¼€è¿æ¥çš„æç¤ºå¹¶è‡ªåŠ¨é€€å‡º

---

## ä»£ç ä¿®æ”¹æ€»ç»“

### client.c çš„æ”¹åŠ¨

**æ–°å¢å…¨å±€å˜é‡**ï¼ˆè¡Œ13-14ï¼‰ï¼š
```c
volatile int connection_closed = 0;
pthread_mutex_t connection_mutex = PTHREAD_MUTEX_INITIALIZER;
```

**ä¸»å¾ªç¯æ”¹åŠ¨**ï¼ˆè¡Œ75-80ï¼‰ï¼š
```c
// æ£€æŸ¥è¿æ¥æ˜¯å¦å·²æ–­å¼€
pthread_mutex_lock(&connection_mutex);
if (connection_closed) {
    pthread_mutex_unlock(&connection_mutex);
    break;
}
pthread_mutex_unlock(&connection_mutex);
```

**æ¥æ”¶çº¿ç¨‹æ”¹åŠ¨**ï¼ˆè¡Œ127-145ï¼‰ï¼š
```c
// è¿æ¥å·²æ–­å¼€çš„å¤„ç†
if (len == 0) {
    printf("\nâŒ æœåŠ¡å™¨å·²æ–­å¼€è¿æ¥ï¼\n");
    fflush(stdout);
} else if (len < 0) {
    perror("âŒ æ¥æ”¶æ•°æ®å¤±è´¥");
    fflush(stdout);
}

// è®¾ç½®è¿æ¥æ–­å¼€æ ‡å¿—
pthread_mutex_lock(&connection_mutex);
connection_closed = 1;
pthread_mutex_unlock(&connection_mutex);

printf("ğŸ’¤ ç¨‹åºå³å°†é€€å‡º...\n");
fflush(stdout);
```

---

## çº¿ç¨‹å®‰å…¨åˆ†æ

### æ½œåœ¨ç«æ€æ¡ä»¶

**é—®é¢˜**ï¼šä¸»çº¿ç¨‹å’Œæ¥æ”¶çº¿ç¨‹åŒæ—¶è®¿é—® `connection_closed`

```
æ—¶é—´çº¿ç¨‹Aï¼ˆä¸»ï¼‰       æ—¶é—´çº¿ç¨‹Bï¼ˆæ¥æ”¶ï¼‰
1.   æ£€æŸ¥flag=0        
2.   å‡†å¤‡è¾“å…¥         
3.                     è®¾ç½®flag=1
4.   fgets()            
5.   å¡ä½              
```

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨äº’æ–¥é”åŒæ­¥

```c
// æ¥æ”¶çº¿ç¨‹
pthread_mutex_lock(&connection_mutex);
connection_closed = 1;
pthread_mutex_unlock(&connection_mutex);

// ä¸»çº¿ç¨‹
pthread_mutex_lock(&connection_mutex);
if (connection_closed) {
    pthread_mutex_unlock(&connection_mutex);
    break;
}
pthread_mutex_unlock(&connection_mutex);
```

### ä¸ºä»€ä¹ˆä¸ç”¨ä¿¡å·å¤„ç†ï¼Ÿ

ä¸ä½¿ç”¨ä¿¡å·çš„åŸå› ï¼š
- `fgets()` é˜»å¡æ—¶ï¼Œä¿¡å·å¯èƒ½ä¸­æ–­
- éœ€è¦é¢å¤–çš„ä¿¡å·å¤„ç†ä»£ç 
- äº’æ–¥é”æ–¹å¼æ›´ç®€æ´æ¸…æ™°
- ç¬¦åˆPOSIXæœ€ä½³å®è·µ

---

## å±€é™å’Œæ”¹è¿›

### å½“å‰é™åˆ¶

1. **ä¸»çº¿ç¨‹é˜»å¡åœ¨ fgets()**
   - å¦‚æœç”¨æˆ·æ²¡æœ‰è¾“å…¥ï¼Œä¸»çº¿ç¨‹ä¼šé˜»å¡
   - æ— æ³•ç«‹å³å“åº”è¿æ¥æ–­å¼€
   - ä½†ä¸€æ—¦ç”¨æˆ·å›è½¦ï¼Œä¼šç«‹å³æ£€æµ‹å¹¶é€€å‡º

2. **æ— æ³•é€šçŸ¥ä¸»çº¿ç¨‹**
   - æ¥æ”¶çº¿ç¨‹åªèƒ½è®¾ç½®æ ‡å¿—
   - æ— æ³•ä¸­æ–­ `fgets()` è°ƒç”¨

### æ”¹è¿›æ–¹æ¡ˆï¼ˆå¯é€‰ï¼‰

**æ–¹æ¡ˆ1ï¼šä½¿ç”¨ select() æ›¿ä»£ fgets()**
```c
fd_set readfds;
FD_SET(STDIN_FILENO, &readfds);
FD_SET(sockfd, &readfds);

int ret = select(sockfd + 1, &readfds, NULL, NULL, &timeout);
if (FD_ISSET(STDIN_FILENO, &readfds)) {
    // ç”¨æˆ·è¾“å…¥
}
if (FD_ISSET(sockfd, &readfds)) {
    // æœåŠ¡å™¨æ¶ˆæ¯
}
```

**æ–¹æ¡ˆ2ï¼šä½¿ç”¨ç®¡é“ï¼ˆpipeï¼‰å”¤é†’ä¸»çº¿ç¨‹**
```c
int pipe_fd[2];
pipe(pipe_fd);
// æ¥æ”¶çº¿ç¨‹åœ¨è¿æ¥æ–­å¼€æ—¶å†™å…¥ç®¡é“
// ä¸»çº¿ç¨‹ç›‘å¬ç®¡é“è¯»ç«¯
```

**æ–¹æ¡ˆ3ï¼šä½¿ç”¨æ¡ä»¶å˜é‡ï¼ˆcondition variableï¼‰**
```c
pthread_cond_t conn_cond = PTHREAD_COND_INITIALIZER;
// æ¥æ”¶çº¿ç¨‹å‘ä¿¡å·
pthread_cond_signal(&conn_cond);
// ä¸»çº¿ç¨‹ç­‰å¾…ä¿¡å·
pthread_cond_wait(&conn_cond, &mutex);
```

---

## æ€§èƒ½è€ƒè™‘

### äº’æ–¥é”å¼€é”€

- æ¯ä¸ªè¾“å…¥å¾ªç¯æ£€æŸ¥ä¸€æ¬¡ï¼ˆçº¦10-100msé—´éš”ï¼‰
- äº’æ–¥é”æ“ä½œéå¸¸å¿«ï¼ˆçº³ç§’çº§ï¼‰
- æ€»å¼€é”€å¯å¿½ç•¥ä¸è®¡

### å†…å­˜å ç”¨

- ä¸¤ä¸ªå…¨å±€å˜é‡ï¼š~8å­—èŠ‚
- ä¸€ä¸ªäº’æ–¥é”ï¼š~40å­—èŠ‚
- æ€»è®¡ï¼š<100å­—èŠ‚å¢åŠ 

### å“åº”æ—¶é—´

- æ£€æµ‹æ—¶é—´ï¼šç«‹å³ï¼ˆæ¥æ”¶çº¿ç¨‹æ£€æµ‹åˆ°ï¼‰
- å“åº”æ—¶é—´ï¼šæœ€å¤šå»¶è¿Ÿä¸€æ¬¡ fgets() çš„æ—¶é—´
- å…¸å‹æƒ…å†µï¼š<100ms

---

## ä¸å…¶ä»–å®¢æˆ·ç«¯çš„äº¤äº’

### å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥

æ¯ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ï¼š
- `connection_closed` æ ‡å¿—
- `connection_mutex` äº’æ–¥é”

æ‰€ä»¥å¤šä¸ªå®¢æˆ·ç«¯ä¸ä¼šç›¸äº’å¹²æ‰°ã€‚

```
å®¢æˆ·ç«¯è¿›ç¨‹1          å®¢æˆ·ç«¯è¿›ç¨‹2
â”œâ”€ connection_closed1  â”œâ”€ connection_closed2
â”œâ”€ mutex1              â”œâ”€ mutex2

å½“æœåŠ¡å™¨æ–­å¼€æ—¶ï¼š
â”œâ”€ æ¥æ”¶çº¿ç¨‹1è®¾ç½®flag1  â”œâ”€ æ¥æ”¶çº¿ç¨‹2è®¾ç½®flag2
â”œâ”€ ä¸»çº¿ç¨‹1æ£€æŸ¥flag1    â”œâ”€ ä¸»çº¿ç¨‹2æ£€æŸ¥flag2
```

---

## å¸¸è§é—®é¢˜

**Q1: ä¸ºä»€ä¹ˆç”¨ `volatile`ï¼Ÿ**
A: é˜²æ­¢ç¼–è¯‘å™¨åœ¨å¾ªç¯ä¸­ä¼˜åŒ–æ‰å˜é‡æ£€æŸ¥ã€‚ç¼–è¯‘å™¨å¯èƒ½è®¤ä¸º `connection_closed` ä¸ä¼šæ”¹å˜è€Œè·³è¿‡æ£€æŸ¥ã€‚

**Q2: å¯ä»¥ä¸ç”¨äº’æ–¥é”å—ï¼Ÿ**
A: åœ¨æŸäº›ç®€å•æƒ…å†µä¸‹å¯èƒ½å¯ä»¥ï¼Œä½†ï¼š
- ä¸å®‰å…¨ï¼ˆæ•°æ®ç«äº‰ï¼‰
- è¿å POSIX æ ‡å‡†
- åœ¨å¤šæ ¸CPUä¸Šå¯èƒ½å‡ºç°é—®é¢˜
- åº”è¯¥å§‹ç»ˆä½¿ç”¨äº’æ–¥é”

**Q3: ä¸ºä»€ä¹ˆè¦ fflush()ï¼Ÿ**
A: ç¡®ä¿è¾“å‡ºç«‹å³æ˜¾ç¤ºï¼Œä¸è¢«ç¼“å†²ã€‚å°¤å…¶åœ¨ç®¡é“æˆ–é‡å®šå‘æ—¶é‡è¦ã€‚

**Q4: æ¥æ”¶çº¿ç¨‹é€€å‡ºåä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ**
A: 
- çº¿ç¨‹è¢«åˆ†ç¦»ï¼ˆdetachedï¼‰
- èµ„æºè‡ªåŠ¨é‡Šæ”¾
- ä¸»çº¿ç¨‹ç»§ç»­è¿è¡Œ
- ä¸‹ä¸€ä¸ª fgets() æ—¶æ£€æµ‹åˆ°æ ‡å¿—å¹¶é€€å‡º

**Q5: å¦‚æœæœåŠ¡å™¨ç½‘ç»œå¡é¡¿ä¼šæ€æ ·ï¼Ÿ**
A: 
- å¦‚æœ recv() è¶…æ—¶ï¼Œè¿”å› -1
- æ‰“å° "âŒ æ¥æ”¶æ•°æ®å¤±è´¥"
- è®¾ç½®æ ‡å¿—å¹¶é€€å‡º
- å…·ä½“è¡Œä¸ºå–å†³äºå¥—æ¥å­—è¶…æ—¶è®¾ç½®

---

## æ‰©å±•å»ºè®®

1. **æ·»åŠ é‡è¿æœºåˆ¶**
   - æ£€æµ‹åˆ°æ–­å¼€æ—¶å°è¯•é‡æ–°è¿æ¥
   - é€€é¿ç®—æ³•ï¼ˆexponential backoffï¼‰

2. **å¿ƒè·³æ£€æµ‹**
   - å®šæœŸå‘é€å¿ƒè·³åŒ…
   - æ£€æµ‹"åƒµå°¸è¿æ¥"

3. **æ—¥å¿—è®°å½•**
   - è®°å½•è¿æ¥çŠ¶æ€å˜åŒ–
   - ç”¨äºæ•…éšœåˆ†æ

4. **ç”¨æˆ·é€‰é¡¹**
   - å…è®¸ç”¨æˆ·é€‰æ‹©è‡ªåŠ¨é‡è¿æˆ–é€€å‡º
   - é…ç½®æ–‡ä»¶è®¾ç½®

---

**ç‰ˆæœ¬**ï¼šv1.1.0ï¼ˆå«æ–­çº¿æ£€æµ‹ï¼‰  
**å®Œæˆæ—¥æœŸ**ï¼š2025å¹´12æœˆ4æ—¥  
**ä»£ç è¡Œæ•°**ï¼šå¢åŠ  ~30 è¡Œä»£ç 

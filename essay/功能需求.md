
          
**功能需求说明（Software Requirements Specification）**

- 范围：`/home/chasen/lcz/learn_linux/linux应用开发/class/SimpleChat_CS`
- 版本：v2.0，基于 TCP Socket，`epoll`，pthread
- 源码参考：`server/server.c`、`client/client.c`、`include/protocol.h`、`server/protocol.c`

**1. 概述**
- 目标：实现一个基于 C/S 架构的多人实时聊天系统，支持注册、公聊、私聊、在线列表、断开检测，满足并发连接处理与稳定性要求。
- 读者对象：课程设计评审、开发人员、测试人员。
- 术语：
  - 公聊：对所有在线用户广播的消息。
  - 私聊：发给指定用户的一对一消息。
  - 在线列表：当前已登录的用户名集合。
  - 协议包：`ChatPacket`，包含消息类型、长度、发送者、数据。

**2. 业务需求**
- 用户可以注册用户名并加入聊天室。
- 用户可以发送公聊消息，所有在线用户可见。
- 用户可以向指定用户发送私聊消息。
- 用户可以查看在线用户列表。
- 用户可以主动退出；异常断开时系统能感知并清理。
- 可扩展管理员命令（踢人、查询在线数）。
- 可扩展聊天日志记录。

**3. 功能需求**
- 用户注册与登录
  - 描述：客户端输入用户名后向服务器发送注册请求，服务器记入在线列表并广播加入通知。
  - 前置条件：服务器运行，客户端可连接。
  - 触发事件：客户端发送 `MSG_REGISTER`。
  - 正常流程：
    - 客户端打包用户名并发送（`client/client.c:87–90`）。
    - 服务器设置用户状态为登录，广播系统消息（`server/server.c:68–92, 86–90`）。
    - 服务器向该用户发送当前在线列表（`server/server.c:83–85, 186–214`）。
  - 失败处理：用户名为空或连接异常，服务器拒绝或断开连接（`server/server.c:48–63`）。
- 公聊消息
  - 描述：用户输入文本，客户端打包为 `MSG_PUBLIC_CHAT`，服务器广播至所有在线用户。
  - 触发事件：客户端输入非命令文本。
  - 正常流程：`client/client.c:165–168` → `server/server.c:94–101, 163–173`。
  - 失败处理：发送或接收失败时提示错误并清理连接（`server/server.c:52–63`；`client/client.c:226–239`）。
- 私聊消息
  - 描述：`/pm <用户名> <消息>` 一对一聊天，客户端打包为 `target:message`，服务器定向转发。
  - 正常流程：`client/client.c:139–153` → `server/server.c:103–135` → 目标用户接收（`client/client.c:200–203`）。
  - 边界情况：目标用户不在线时返回系统提示（`server/server.c:127–131`）。
- 在线用户列表
  - 描述：用户输入 `/list` 请求，服务器返回所有已登录用户名的字符串。
  - 正常流程：`client/client.c:131–134` → `server/server.c:137–143, 186–214` → 客户端展示（`client/client.c:210–213`）。
- 断开与异常处理
  - 主动断开：`/exit` 触发 `MSG_DISCONNECT`，服务器广播离线消息并清理（`client/client.c:125–131`；`server/server.c:145–155, 236–251`）。
  - 异常断开：服务器端 `recv<=0` 检测到断开，广播并清理（`server/server.c:48–63`）；客户端接收线程检测断开并提示退出（`client/client.c:222–239`）。
- 帮助与交互
  - `/help` 显示命令帮助（`client/client.c:22–33, 135–138`）。
- 管理员命令（可选）
  - `/kick <用户名>`：服务器移除指定用户；扩展点：命令解析与服务端路由（`client/client.c:122–163`；`server/server.c:66–161`）。
  - `/online`：返回在线用户计数；扩展点：统计函数与系统消息响应（`server/server.c:186–205`）。

**4. 非功能需求**
- 性能
  - 并发连接：支持至少 10 个同时在线（`include/protocol.h:8`）。
  - I/O 模型：`epoll` 单线程事件驱动，非阻塞套接字（`server/server.c:28–40, 306–343`）。
- 可靠性
  - 异常断开检测与资源清理（`server/server.c:48–63, 236–251`；`client/client.c:222–239`）。
  - 错误处理：系统调用返回值检查与 `perror` 提示（多处）。
- 可维护性
  - 模块化：客户端、服务器、协议分离，公共协议实现复用（`server/protocol.c` 同时被客户端/服务器使用）。
  - 构建：`Makefile` 目标与依赖清晰（`Makefile:1–51`）。
- 可扩展性
  - 协议留有类型扩展位（`include/protocol.h:13–23`）。
  - 模块可替换：`select/poll` 可在 `epoll` 处扩展为策略选择。

**5. 数据与接口需求**
- 数据结构
  - `ChatPacket`：`type/length/sender/data`（`include/protocol.h:25–31`）。
  - `ClientInfo`：`name/sockfd/logged_in/login_time`（`include/protocol.h:33–39`）。
- 接口与调用
  - 打包：`pack_message`（`server/protocol.c:4–26`）。
  - 解包：`unpack_message`（`server/protocol.c:29–39`）。
  - 服务器公共接口：
    - `broadcast_message`（`server/server.c:163–173`）
    - `send_user_list_to_client`（`server/server.c:186–214`）
    - `find_client_by_name`、`find_client_by_fd`（`server/server.c:216–234`）
    - `remove_client`（`server/server.c:236–251`）
  - 客户端公共接口：
    - `send_command_to_server`（`client/client.c:35–40`）
    - `receive_messages`（`client/client.c:178–219`）

**6. 运行与状态需求**
- 状态管理
  - 登录状态：`ClientInfo.logged_in`（`include/protocol.h:37`），在注册成功时设置（`server/server.c:71–74`）。
  - 客户端连接状态：`connection_closed` + `mutex`（`client/client.c:13–16, 97–107, 231–233`）。
- 生命周期
  - 服务器：初始化 → 监听 → 接入 → 事件循环 → 清理（`server/server.c:254–448`）。
  - 客户端：输入用户名 → 连接 → 创建接收线程 → 命令循环 → 退出（`client/client.c:42–176`）。

**7. 约束与假设**
- 运行平台：Linux。
- 编译：GCC，C99，`-pthread`，`-I./include`（`Makefile:3–6, 32–35`）。
- 最大在线数：`MAX_CLIENTS=10`（`include/protocol.h:8`）。
- 端口：`PORT=8088`（`include/protocol.h:11`）。
- 字符串长度约束：`NAME_SIZE=20`、`BUFFER_SIZE=1024`（`include/protocol.h:10, 9`）。

**8. 验收标准**
- 能够成功编译与运行（`Makefile:19–31`；`README.md:82–110, 112–121`）。
- 多客户端连接与交互正常（`demo.sh:1–58`、`test_client.sh:1–48`）。
- 公聊与私聊消息传输正确（服务端路由与客户端展示位置详见上文）。
- 在线列表显示正确，包含当前在线用户名（`server/server.c:186–214`、`client/client.c:210–213`）。
- 主动退出与异常断开时，系统能广播提示并清理资源（`server/server.c:145–155, 48–63, 236–251`；`client/client.c:222–239`）。
- 文档与代码一致，接口与类型定义清晰可查（`include/protocol.h`、`server/protocol.c`）。

**9. 扩展需求建议（后续实现）**
- 管理员命令：`/kick`、`/online`。
- 持久化聊天日志：服务器端 `chat.log` 统一记录公聊、私聊与上下线事件。
- 重复用户名校验与重名策略。
- 心跳检测与超时处理。
- 安全增强：认证、加密传输。

如果你希望我把以上内容写入到仓库中的一个 `docs/SRS.md` 或 `README` 的专章，请告知具体文件路径；否则我保持现状不创建新文件，仅提供这份需求文档用于你的课程设计写作与评审。
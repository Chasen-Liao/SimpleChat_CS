# SimpleChat_CS - åŸºäºC/Sæ¶æ„çš„å¤šäººèŠå¤©ç³»ç»Ÿ

**ä½œè€…**ï¼šChasen  
**æ›´æ–°æ—¶é—´**ï¼š2025å¹´12æœˆ7æ—¥  
**å½“å‰ç‰ˆæœ¬**ï¼šv2.0 (ä½¿ç”¨epoll + ç§èŠ + åœ¨çº¿åˆ—è¡¨)  
**é¡¹ç›®ç±»å‹**ï¼šLinux Cè¯­è¨€ç½‘ç»œç¼–ç¨‹è¯¾ç¨‹è®¾è®¡

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

SimpleChat_CS æ˜¯ä¸€ä¸ªåŸºäº **TCP Socket** çš„ C/S æ¶æ„å¤šäººå®æ—¶èŠå¤©ç³»ç»Ÿã€‚

### v2.0 ç‰ˆæœ¬ä¸»è¦ç‰¹æ€§
- âœ… **é«˜æ•ˆå¤šè·¯IO**ï¼šé‡‡ç”¨ `epoll` å¤šè·¯IOæ¨¡å‹ï¼ˆéé˜»å¡ï¼‰
- âœ… **ç§èŠåŠŸèƒ½**ï¼šæ”¯æŒç”¨æˆ·é—´çš„ä¸€å¯¹ä¸€ç§å¯†èŠå¤©
- âœ… **åœ¨çº¿åˆ—è¡¨**ï¼šå®æ—¶æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·åˆ—è¡¨
- âœ… **æ¶ˆæ¯å¹¿æ’­**ï¼šå…¬å¼€æ¶ˆæ¯å®æ—¶å¹¿æ’­ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
- âœ… **å¤šå®¢æˆ·ç«¯æ”¯æŒ**ï¼šåŒæ—¶å¤„ç†æœ€å¤š 10 ä¸ªå®¢æˆ·ç«¯è¿æ¥
- âœ… **è¿æ¥ç®¡ç†**ï¼šè‡ªåŠ¨å¤„ç†ç”¨æˆ·åŠ å…¥/ç¦»çº¿é€šçŸ¥

### æ¶æ„å¯¹æ¯”

| ç‰¹æ€§ | v1.0 (å¤šçº¿ç¨‹) | v2.0 (epoll) |
|------|---------|----------|
| IOæ¨¡å‹ | å¤šçº¿ç¨‹ | epollå¤šè·¯IO |
| æ—¶é—´å¤æ‚åº¦ | O(n) | O(1) |
| æœ€å¤§è¿æ¥æ•° | ~100 | 10000+ |
| CPUå ç”¨ | è¾ƒé«˜ | è¾ƒä½ |
| ç§èŠåŠŸèƒ½ | âŒ | âœ… |
| åœ¨çº¿åˆ—è¡¨ | âŒ | âœ… |

---

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
SimpleChat_CS/
â”œâ”€â”€ Makefile                     # ç¼–è¯‘è„šæœ¬
â”œâ”€â”€ README.md                    # æœ¬æ–‡ä»¶ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ UPGRADE_v2.0.md              # â† æ–°å¢ï¼šv2.0å‡çº§è¯´æ˜
â”œâ”€â”€ DEBUGGING_GUIDE.md           # è°ƒè¯•æŒ‡å—
â”œâ”€â”€ demo.sh                       # â† æ–°å¢ï¼šæ¼”ç¤ºè„šæœ¬
â”œâ”€â”€ run_test.sh                  # è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
â”œâ”€â”€ interactive_test.sh          # äº¤äº’å¼å¤šå®¢æˆ·ç«¯æµ‹è¯•
â”‚
â”œâ”€â”€ include/
â”‚   â””â”€â”€ protocol.h               # é€šä¿¡åè®®å®šä¹‰ï¼ˆå·²æ‰©å±•ï¼‰
â”‚       â”œâ”€â”€ æ–°å¢æ¶ˆæ¯ç±»å‹ï¼šMSG_PRIVATE_CHAT, MSG_USER_LIST
â”‚       â”œâ”€â”€ æ–°å¢ChatPacketä¸­çš„senderå­—æ®µ
â”‚       â””â”€â”€ æ›´æ–°çš„æ‰“åŒ…/è§£åŒ…å‡½æ•°
â”‚
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ server.c                 # æœåŠ¡å™¨ä¸»ç¨‹åºï¼ˆå·²é‡å†™ä¸ºepollï¼‰
â”‚   â”‚   â”œâ”€â”€ epollåˆ›å»ºå’Œç®¡ç†
â”‚   â”‚   â”œâ”€â”€ éé˜»å¡socketå¤„ç†
â”‚   â”‚   â”œâ”€â”€ æ¶ˆæ¯è·¯ç”±å’Œå¹¿æ’­
â”‚   â”‚   â”œâ”€â”€ ç§èŠæ¶ˆæ¯è½¬å‘
â”‚   â”‚   â””â”€â”€ ç”¨æˆ·çŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ protocol.c               # åè®®å®ç°ï¼ˆå·²æ›´æ–°ï¼‰
â”‚       â”œâ”€â”€ pack_message()ï¼šæ¶ˆæ¯æ‰“åŒ…
â”‚       â””â”€â”€ unpack_message()ï¼šæ¶ˆæ¯è§£åŒ…
â”‚
â””â”€â”€ client/
    â””â”€â”€ client.c                 # å®¢æˆ·ç«¯ä¸»ç¨‹åºï¼ˆå·²å‡çº§ï¼‰
        â”œâ”€â”€ å‘½ä»¤è§£æï¼ˆ/list, /pm, /help, /exitï¼‰
        â”œâ”€â”€ ç§èŠæ¶ˆæ¯å‘é€
        â”œâ”€â”€ å¤šçº¿ç¨‹æ¶ˆæ¯æ¥æ”¶
        â””â”€â”€ å¢å¼ºçš„ç”¨æˆ·äº¤äº’
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**ï¼šLinuxï¼ˆUbuntuã€CentOSç­‰ï¼‰
- **ç¼–è¯‘å™¨**ï¼šGCC 4.8+ï¼ˆæ”¯æŒC99æ ‡å‡†ï¼‰
- **APIè¦æ±‚**ï¼šepollï¼ˆLinuxç‰¹æœ‰ï¼Œä»…Linuxå¯ç”¨ï¼‰
- **çº¿ç¨‹åº“**ï¼špthread

### ç¼–è¯‘

```bash
cd /home/chasen/lcz/learn_linux/linuxåº”ç”¨å¼€å‘/class/SimpleChat_CS

# ä¸€é”®ç¼–è¯‘
make

# æˆ–åˆ†åˆ«ç¼–è¯‘
make server      # ä»…ç¼–è¯‘æœåŠ¡å™¨
make client      # ä»…ç¼–è¯‘å®¢æˆ·ç«¯

# æ¸…ç†ç¼–è¯‘æ–‡ä»¶
make clean

# é‡æ–°ç¼–è¯‘
make rebuild
```

**ç¼–è¯‘è¾“å‡ºç¤ºä¾‹**
```
gcc -Wall -Wextra -std=c99 -pthread -I./include -c server/server.c -o server/server.o
gcc -Wall -Wextra -std=c99 -pthread -I./include -c server/protocol.c -o server/protocol.o
gcc -Wall -Wextra -std=c99 -pthread -o server/server server/server.o server/protocol.o
âœ“ æœåŠ¡å™¨ç¼–è¯‘å®Œæˆ: server/server
gcc -Wall -Wextra -std=c99 -pthread -I./include -c client/client.c -o client/client.o
gcc -Wall -Wextra -std=c99 -pthread -o client/client client/client.o server/protocol.o
âœ“ å®¢æˆ·ç«¯ç¼–è¯‘å®Œæˆ: client/client
```

### è¿è¡Œ

#### æ–¹å¼1ï¼šæ‰‹åŠ¨å¯åŠ¨ï¼ˆæ¨èå­¦ä¹ ï¼‰

**ç»ˆç«¯1 - å¯åŠ¨æœåŠ¡å™¨**
```bash
cd /home/chasen/lcz/learn_linux/linuxåº”ç”¨å¼€å‘/class/SimpleChat_CS
./server/server
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
ğŸ”— æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£ 8088 (ä½¿ç”¨ epoll å¤šè·¯IO)
â³ ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥......
ğŸ“± æ–°è¿æ¥æ¥å— (FD: 5, æ€»è¿æ¥æ•°: 1)
âœ“ Alice ç™»å½•äº† (FD: 5)
```

**ç»ˆç«¯2 - å¯åŠ¨å®¢æˆ·ç«¯1ï¼ˆAliceï¼‰**
```bash
cd /home/chasen/lcz/learn_linux/linuxåº”ç”¨å¼€å‘/class/SimpleChat_CS
./client/client
```

æŒ‰æç¤ºè¾“å…¥ç”¨æˆ·åï¼ˆAliceï¼‰ï¼Œç„¶åå¯è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š
- `å¤§å®¶å¥½` - å‘é€å…¬å¼€æ¶ˆæ¯
- `/list` - æŸ¥çœ‹åœ¨çº¿ç”¨æˆ·
- `/help` - æ˜¾ç¤ºå¸®åŠ©
- `/exit` - é€€å‡º

**ç»ˆç«¯3 - å¯åŠ¨å®¢æˆ·ç«¯2ï¼ˆBobï¼‰**
```bash
cd /home/chasen/lcz/learn_linux/linuxåº”ç”¨å¼€å‘/class/SimpleChat_CS
./client/client
```

è¾“å…¥ç”¨æˆ·åï¼ˆBobï¼‰ï¼Œç„¶åå¯ä»¥ï¼š
- å‘é€å…¬å¼€æ¶ˆæ¯
- å‘é€ç§èŠï¼š`/pm Alice ä½ å¥½Alice`

#### æ–¹å¼2ï¼šè‡ªåŠ¨æ¼”ç¤ºï¼ˆæ¨èå¿«é€Ÿä½“éªŒï¼‰

```bash
# å¯åŠ¨è‡ªåŠ¨æ¼”ç¤ºï¼ˆä¸€é”®å¯åŠ¨3ä¸ªå®¢æˆ·ç«¯è¿›è¡Œäº¤äº’ï¼‰
bash demo.sh
```

è¿™å°†è‡ªåŠ¨ï¼š
1. å¯åŠ¨Aliceå®¢æˆ·ç«¯
2. å¯åŠ¨Bobå®¢æˆ·ç«¯
3. å¯åŠ¨Charlieå®¢æˆ·ç«¯
4. æ¼”ç¤ºå…¬èŠã€ç§èŠã€åœ¨çº¿åˆ—è¡¨ç­‰åŠŸèƒ½

---

## ğŸ’¬ å®¢æˆ·ç«¯å‘½ä»¤è¯¦è§£

| å‘½ä»¤ | è¯´æ˜ | ç¤ºä¾‹ | æ•ˆæœ |
|------|------|------|------|
| ä»»æ„æ–‡æœ¬ | å‘é€å…¬å¼€æ¶ˆæ¯ | `å¤§å®¶å¥½ï¼` | æ‰€æœ‰åœ¨çº¿ç”¨æˆ·éƒ½èƒ½çœ‹åˆ° |
| `/list` | æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ· | `/list` | æ˜¾ç¤ºå½“å‰åœ¨çº¿çš„æ‰€æœ‰ç”¨æˆ·å |
| `/pm <ç”¨æˆ·> <æ¶ˆæ¯>` | å‘é€ç§èŠ | `/pm Alice ä½ å¥½` | ä»…Aliceèƒ½çœ‹åˆ°æ¶ˆæ¯ |
| `/help` | æ˜¾ç¤ºå¸®åŠ© | `/help` | æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨å‘½ä»¤ |
| `/exit` | é€€å‡ºèŠå¤©å®¤ | `/exit` | é€€å‡ºç¨‹åºï¼Œé€šçŸ¥å…¶ä»–ç”¨æˆ· |

### ä½¿ç”¨ç¤ºä¾‹

```
> /list
ğŸ“‹ åœ¨çº¿ç”¨æˆ·: Alice, Bob, Charlie

> å¤§å®¶å¥½ï¼Œä»Šå¤©å¤©æ°”çœŸå¥½
[å…¬å¼€] Alice: å¤§å®¶å¥½ï¼Œä»Šå¤©å¤©æ°”çœŸå¥½

> /pm Bob ä½ æœ€è¿‘åœ¨å¿™ä»€ä¹ˆå‘¢
âœ“ ç§èŠå·²å‘é€ç»™ Bob

> /help
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       ğŸ® èŠå¤©å®¤å‘½ä»¤å¸®åŠ©                 â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ /list  - æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·åˆ—è¡¨                â•‘
â•‘ /pm <ç”¨æˆ·å> <æ¶ˆæ¯> - å‘é€ç§èŠ           â•‘
â•‘         ä¾‹: /pm Alice ä½ å¥½             â•‘
â•‘ /help  - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯                 â•‘
â•‘ /exit  - é€€å‡ºèŠå¤©å®¤                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

> /exit
ğŸ‘‹ æ­£åœ¨é€€å‡º...
```

---

## ğŸ“Š æ¶ˆæ¯æµç¨‹ç¤ºä¾‹

### å…¬å¼€æ¶ˆæ¯å¹¿æ’­
```
[Alice] â†’ è¾“å…¥ï¼šå¤§å®¶å¥½
         â†“
[Server] â†’ æ¥æ”¶ï¼Œè¯†åˆ«ä¸ºMSG_PUBLIC_CHAT
         â†“
[Server] â†’ å¹¿æ’­ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆBob, Charlieï¼‰
         â†“
[Bob] â† æ¥æ”¶ï¼š[Alice]: å¤§å®¶å¥½
[Charlie] â† æ¥æ”¶ï¼š[Alice]: å¤§å®¶å¥½
```

### ç§èŠè·¯ç”±
```
[Bob] â†’ è¾“å…¥ï¼š/pm Alice ä½ å¥½Alice
       â†“
[Client] â†’ æ‰“åŒ…ï¼šMSG_PRIVATE_CHAT, data="Alice:ä½ å¥½Alice"
         â†“
[Server] â†’ æ”¶åˆ°ï¼Œè¯†åˆ«ä¸ºMSG_PRIVATE_CHAT
         â†“
[Server] â†’ æŸ¥æ‰¾Aliceï¼Œæ„å»ºç§èŠåŒ…
         â†“
[Alice] â† æ¥æ”¶ï¼šğŸ’¬ [ç§èŠæ¥è‡ª Bob]: ä½ å¥½Alice
[Bob] â† æ¥æ”¶ï¼šâœ“ ç§èŠå·²å‘é€ç»™ Alice
```

### åœ¨çº¿åˆ—è¡¨æŸ¥è¯¢
```
[Charlie] â†’ è¾“å…¥ï¼š/list
          â†“
[Client] â†’ å‘é€ï¼šMSG_USER_LIST
         â†“
[Server] â†’ æ”¶é›†æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·
         â†“
[Charlie] â† æ¥æ”¶ï¼šğŸ“‹ åœ¨çº¿ç”¨æˆ·: Alice, Bob, Charlie
```
./run_test.sh

# å¤šå®¢æˆ·ç«¯äº¤äº’å¼æµ‹è¯•
./interactive_test.sh

# æµ‹è¯•æœåŠ¡å™¨æ–­å¼€è¿æ¥æ—¶çš„å®¢æˆ·ç«¯ååº”
./test_disconnect.sh

### ä½¿ç”¨æ¼”ç¤º

```
==================== å®¢æˆ·ç«¯1 ====================
è¯·è¾“å…¥ç”¨æˆ·å:
Alice
æ­£åœ¨è¿æ¥åˆ°æœåŠ¡å™¨ 127.0.0.1:8088...
âœ“ å·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼
å‘é€ç”¨æˆ·å: Alice
ğŸ’¬ è¯·è¾“å…¥æ¶ˆæ¯ (è¾“å…¥ 'exit' é€€å‡º):
Hello everyone!
ğŸ‘‹ æ­£åœ¨é€€å‡º...

==================== å®¢æˆ·ç«¯2 ====================
è¯·è¾“å…¥ç”¨æˆ·å:
Bob
æ­£åœ¨è¿æ¥åˆ°æœåŠ¡å™¨ 127.0.0.1:8088...
âœ“ å·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼
å‘é€ç”¨æˆ·å: Bob
ğŸ’¬ è¯·è¾“å…¥æ¶ˆæ¯ (è¾“å…¥ 'exit' é€€å‡º):
Hi Alice!
[Alice]: Hello everyone!
[Bob]: Hi Alice!
ğŸ‘‹ æ­£åœ¨é€€å‡º...

==================== æœåŠ¡å™¨ ====================
ğŸ”— æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£ 8088
â³ ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥......
Alice è¿›å…¥èŠå¤©å®¤
[Alice] Hello everyone!
Bob è¿›å…¥èŠå¤©å®¤
[Bob] Hi Alice!
Alice å·²é€€å‡ºèŠå¤©å®¤
Bob å·²é€€å‡ºèŠå¤©å®¤
```
---

## ğŸ“‹ åŠŸèƒ½è¯´æ˜

### 1. ç”¨æˆ·æ³¨å†Œä¸è¿æ¥
- å®¢æˆ·ç«¯å¯åŠ¨åè¾“å…¥ç”¨æˆ·å
- æœåŠ¡å™¨éªŒè¯å¹¶æ·»åŠ åˆ°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
- å¹¿æ’­ "ç”¨æˆ·å è¿›å…¥èŠå¤©å®¤" æ¶ˆæ¯

### 2. å…¬å…±èŠå¤©
- ç”¨æˆ·è¾“å…¥æ¶ˆæ¯æŒ‰å›è½¦å‘é€
- æ¶ˆæ¯æ ¼å¼ï¼š`[ç”¨æˆ·å]: æ¶ˆæ¯å†…å®¹`
- æœåŠ¡å™¨å¹¿æ’­ç»™æ‰€æœ‰å®¢æˆ·ç«¯

### 3. ç”¨æˆ·æ–­å¼€
- è¾“å…¥ `exit` å‘½ä»¤é€€å‡º
- æœåŠ¡å™¨å¹¿æ’­ "ç”¨æˆ·å å·²é€€å‡ºèŠå¤©å®¤"
- ä»åœ¨çº¿åˆ—è¡¨ä¸­ç§»é™¤

### 4. æœåŠ¡å™¨æ–­å¼€è¿æ¥æ£€æµ‹ -- æ–°å¢
- å½“æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€è¿æ¥æ—¶
- å®¢æˆ·ç«¯æ¥æ”¶çº¿ç¨‹ç«‹å³æ£€æµ‹åˆ° (recv è¿”å›0)
- æ˜¾ç¤ºæç¤ºä¿¡æ¯ï¼š`âŒ æœåŠ¡å™¨å·²æ–­å¼€è¿æ¥ï¼`
- è‡ªåŠ¨æ¸…ç†èµ„æºå¹¶é€€å‡ºç¨‹åº
- å³ä½¿ç”¨æˆ·æ­£åœ¨è¾“å…¥ä¹Ÿä¼šç«‹å³å“åº”

### 5. é”™è¯¯å¤„ç†
- è¿æ¥å¤±è´¥æ—¶æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
- è‡ªåŠ¨å¤„ç†å®¢æˆ·ç«¯å¼‚å¸¸æ–­å¼€
- çº¿ç¨‹å®‰å…¨çš„èµ„æºæ¸…ç†
- æœåŠ¡å™¨å¼‚å¸¸æ–­å¼€æ—¶çš„ä¼˜é›…å¤„ç†

---

## ğŸ”§ æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿæ¶æ„

![1](ç³»ç»Ÿæ¶æ„å›¾.png)

### é€šä¿¡åè®® (protocol.h)

```c
// æ¶ˆæ¯ç±»å‹å®šä¹‰
typedef enum {
    MSG_REGISTER = 1,       // æ³¨å†Œæ¶ˆæ¯
    MSG_PUBLIC_CHAT = 2,    // å…¬å…±èŠå¤©
    MSG_PRIVATE_CHAT = 3,   // ç§èŠï¼ˆé¢„ç•™ï¼‰
    MSG_USER_LIST = 4,      // ç”¨æˆ·åˆ—è¡¨ï¼ˆé¢„ç•™ï¼‰
    MSG_DISCONNECT = 5      // æ–­å¼€è¿æ¥
} MessageType;

// é€šä¿¡åŒ…ç»“æ„
typedef struct {
    MessageType type;           // æ¶ˆæ¯ç±»å‹
    int length;                 // æ¶ˆæ¯é•¿åº¦
    char data[BUFFER_SIZE];     // æ¶ˆæ¯æ•°æ®
} ChatPacket;

// å®¢æˆ·ç«¯ç»“æ„
typedef struct {
    char name[NAME_SIZE];       // å®¢æˆ·ç«¯åç§°
    int sockfd;                 // å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦
} ClientInfo;
```

### é…ç½®å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `MAX_CLIENTS` | 10 | æœ€å¤§è¿æ¥å®¢æˆ·ç«¯æ•° |
| `BUFFER_SIZE` | 1024 | æ¶ˆæ¯ç¼“å†²åŒºå¤§å° |
| `NAME_SIZE` | 20 | ç”¨æˆ·åæœ€å¤§é•¿åº¦ |
| `PORT` | 8088 | æœåŠ¡å™¨ç›‘å¬ç«¯å£ |

## **æœåŠ¡å™¨å¤„ç†æµç¨‹ï¼š**

![2](æœåŠ¡ç«¯æ¨¡å—.png)




## **å®¢æˆ·ç«¯å¤„ç†æµç¨‹ï¼š**

![3](å®¢æˆ·ç«¯æ¨¡å—.png)

### çº¿ç¨‹åŒæ­¥æœºåˆ¶

**æœåŠ¡å™¨äº’æ–¥é” (pthread_mutex_t)**
- ä¿æŠ¤å®¢æˆ·ç«¯åˆ—è¡¨ `clients[]` çš„å¹¶å‘è®¿é—®
- é˜²æ­¢ç«æ€æ¡ä»¶ï¼ˆrace conditionï¼‰
- ç¡®ä¿æ¶ˆæ¯å¹¿æ’­çš„ä¸€è‡´æ€§

```c
// åˆå§‹åŒ–
pthread_mutex_init(&client_mutex, NULL);

// ä½¿ç”¨
pthread_mutex_lock(&client_mutex);    // åŠ é”
// ... è®¿é—®å…±äº«æ•°æ® ...
pthread_mutex_unlock(&client_mutex);  // è§£é”

// é”€æ¯
pthread_mutex_destroy(&client_mutex);
```

**å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€åŒæ­¥ â­ æ–°å¢**
- ä¿æŠ¤ `connection_closed` è¿æ¥çŠ¶æ€æ ‡å¿—
- ä¸»çº¿ç¨‹å’Œæ¥æ”¶çº¿ç¨‹å®‰å…¨å…±äº«çŠ¶æ€
- æ£€æµ‹æœåŠ¡å™¨æ–­å¼€è¿æ¥

```c
// å…¨å±€å˜é‡
volatile int connection_closed = 0;  // 0=è¿æ¥ä¸­ï¼Œ1=è¿æ¥å·²æ–­å¼€
pthread_mutex_t connection_mutex = PTHREAD_MUTEX_INITIALIZER;

// åœ¨æ¥æ”¶çº¿ç¨‹ä¸­è®¾ç½®ï¼ˆæœåŠ¡å™¨æ–­å¼€æ—¶ï¼‰
pthread_mutex_lock(&connection_mutex);
connection_closed = 1;
pthread_mutex_unlock(&connection_mutex);

// åœ¨ä¸»çº¿ç¨‹ä¸­æ£€æŸ¥ï¼ˆæ¯ä¸ªè¾“å…¥å¾ªç¯ï¼‰
pthread_mutex_lock(&connection_mutex);
if (connection_closed) {
    pthread_mutex_unlock(&connection_mutex);
    break;  // é€€å‡ºè¾“å…¥å¾ªç¯
}
pthread_mutex_unlock(&connection_mutex);
```

**å…³é”®ä¿æŠ¤åŒºåŸŸï¼š**
1. æ¥å—æ–°å®¢æˆ·ç«¯æ—¶
2. å¹¿æ’­æ¶ˆæ¯æ—¶
3. å®¢æˆ·ç«¯æ–­å¼€æ—¶

---

## ğŸ“Š ç¼–è¯‘é€‰é¡¹è¯´æ˜

```makefile
CC = gcc                                    # Cç¼–è¯‘å™¨
CFLAGS = -Wall -Wextra -std=c99 -pthread   # ç¼–è¯‘æ ‡å¿—
INCLUDES = -I./include                     # åŒ…å«ç›®å½•
```

| é€‰é¡¹ | å«ä¹‰ |
|------|------|
| `-Wall` | æ˜¾ç¤ºæ‰€æœ‰è­¦å‘Šä¿¡æ¯ |
| `-Wextra` | æ˜¾ç¤ºé¢å¤–çš„è­¦å‘Šä¿¡æ¯ |
| `-std=c99` | ä½¿ç”¨C99æ ‡å‡†ç¼–è¯‘ |
| `-pthread` | é“¾æ¥pthreadåº“ |
| `-I./include` | æŒ‡å®šå¤´æ–‡ä»¶æœç´¢ç›®å½• |

**Makefile ç›®æ ‡ï¼š**

```bash
make              # ç¼–è¯‘æ‰€æœ‰ç›®æ ‡
make server       # ä»…ç¼–è¯‘æœåŠ¡å™¨
make client       # ä»…ç¼–è¯‘å®¢æˆ·ç«¯
make clean        # åˆ é™¤ç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶
make rebuild      # æ¸…ç†åé‡æ–°ç¼–è¯‘
make debug        # æ˜¾ç¤ºç¼–è¯‘å˜é‡
```

---

## ğŸ› å¸¸è§é—®é¢˜ä¸è§£å†³

### é—®é¢˜1ï¼šBind failed: Address already in use
**åŸå› **ï¼šç«¯å£ 8088 è¢«å ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æŸ¥çœ‹å ç”¨è¿›ç¨‹
sudo lsof -i :8088
ss -tlnp | grep 8088

# æ€æ­»è¿›ç¨‹
sudo kill -9 <PID>

# æˆ–è€…ç­‰å¾…1-2åˆ†é’Ÿè®©ç³»ç»Ÿé‡Šæ”¾ç«¯å£
sleep 120
```

### é—®é¢˜2ï¼šConnection refused
**åŸå› **ï¼šæœåŠ¡å™¨æœªå¯åŠ¨æˆ–è¿æ¥åœ°å€é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
ps aux | grep server

# æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
netstat -tlnp | grep 8088
ss -tlnp | grep 8088

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
```

### é—®é¢˜3ï¼šå®¢æˆ·ç«¯è¾“å…¥åæ²¡ååº”
**åŸå› **ï¼šè¿æ¥å¤±è´¥

**æŸ¥çœ‹å®¢æˆ·ç«¯é”™è¯¯æ¶ˆæ¯ï¼š**
- `Connection refused` - æœåŠ¡å™¨æœªå¯åŠ¨
- `Connection timeout` - æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨
- `Permission denied` - æƒé™é—®é¢˜

### é—®é¢˜4ï¼šç¼–è¯‘é”™è¯¯ - æ‰¾ä¸åˆ° pthread å¤´æ–‡ä»¶
**åŸå› **ï¼šç¼ºå°‘å¼€å‘åº“

**è§£å†³æ–¹æ¡ˆ**ï¼ˆUbuntuï¼‰ï¼š
```bash
sudo apt-get update
sudo apt-get install build-essential
sudo apt-get install libpthread-stubs0-dev
```

**è§£å†³æ–¹æ¡ˆ**ï¼ˆCentOSï¼‰ï¼š
```bash
sudo yum install gcc
sudo yum install glibc-devel
```

### é—®é¢˜5ï¼šæœåŠ¡å™¨å¯åŠ¨åç«‹å³é€€å‡º
**åŸå› **ï¼šç»‘å®šæˆ–ç›‘å¬å¤±è´¥

**æ£€æŸ¥æ­¥éª¤ï¼š**
```bash
# æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯è¾“å‡º
./server/server

# æ£€æŸ¥æƒé™
ls -la server/server

# æ£€æŸ¥ç«¯å£
netstat -tlnp | grep 8088
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ | è¯´æ˜ |
|------|-----|------|
| æœ€å¤§è¿æ¥æ•° | 10 | MAX_CLIENTS |
| æ¶ˆæ¯ç¼“å†²åŒº | 1024 å­—èŠ‚ | BUFFER_SIZE |
| ç”¨æˆ·åé•¿åº¦ | 20 å­—ç¬¦ | NAME_SIZE |
| ç›‘å¬ç«¯å£ | 8088 | PORT |
| çº¿ç¨‹æ¨¡å‹ | æ¯å®¢æˆ·ç«¯ä¸€çº¿ç¨‹ | ä¸€å¯¹ä¸€æ¨¡å‹ |
| åŒæ­¥æœºåˆ¶ | äº’æ–¥é” | pthread_mutex |
| ç½‘ç»œåè®® | TCP | é¢å‘è¿æ¥ |

---

## ğŸ” è®¾è®¡ç‰¹ç‚¹

### 1. ç®€æ´é«˜æ•ˆ
- ä»£ç ç®€æ´æ˜“æ‡‚ï¼Œé€‚åˆå­¦ä¹ 
- ç›´æ¥ä½¿ç”¨POSIX API
- æ— å¤æ‚çš„æ¡†æ¶ä¾èµ–
- æ ¸å¿ƒä»£ç ä¸è¶…è¿‡300è¡Œ

### 2. çº¿ç¨‹å®‰å…¨
- ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å…±äº«æ•°æ®
- æ­£ç¡®çš„çº¿ç¨‹åˆ›å»ºå’Œåˆ†ç¦»
- é¿å…æ­»é”å’Œç«æ€æ¡ä»¶
- å®Œæ•´çš„èµ„æºæ¸…ç†

### 3. é”™è¯¯å¤„ç†
- å®Œæ•´çš„é”™è¯¯æ£€æŸ¥
- æ¸…æ™°çš„é”™è¯¯æç¤º
- ä¼˜é›…çš„èµ„æºæ¸…ç†
- perror() æ˜¾ç¤ºç³»ç»Ÿé”™è¯¯

### 4. æ˜“äºæ‰©å±•
- æ¨¡å—åŒ–çš„ä»£ç ç»“æ„
- é¢„ç•™çš„æ¶ˆæ¯ç±»å‹
- é€šä¿¡åè®®å¯æ‰©å±•
- æ˜“äºæ·»åŠ æ–°åŠŸèƒ½

---

## ğŸ“š ä»£ç ç»Ÿè®¡

| æ–‡ä»¶ | è¡Œæ•° | èŒè´£ |
|------|------|------|
| protocol.h | ~40 | åè®®å®šä¹‰ |
| protocol.c | ~30 | æ‰“åŒ…/è§£åŒ…å‡½æ•° |
| server.c | ~169 | æœåŠ¡å™¨ä¸»ç¨‹åº |
| client.c | ~147 | å®¢æˆ·ç«¯ç¨‹åº |
| Makefile | ~35 | ç¼–è¯‘è„šæœ¬ |
| **æ€»è®¡** | **~421** | - |

---

## ğŸ“ å¼€å‘æ—¥å¿—

| æ—¥æœŸ | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| 2025-12-04 | é¡¹ç›®åˆå§‹åŒ–ã€æ–‡ä»¶ç»“æ„è§„åˆ’ | âœ… å®Œæˆ |
| 2025-12-04 | ç¼–å†™protocol.hé€šä¿¡åè®® | âœ… å®Œæˆ |
| 2025-12-04 | å®ç°server.cæœåŠ¡å™¨ä¸»ç¨‹åº | âœ… å®Œæˆ |
| 2025-12-04 | å®ç°client.cå®¢æˆ·ç«¯ç¨‹åº | âœ… å®Œæˆ |
| 2025-12-04 | ç¼–å†™Makefileç¼–è¯‘è„šæœ¬ | âœ… å®Œæˆ |
| 2025-12-04 | é—®é¢˜æ’æŸ¥å’Œé”™è¯¯ä¿®å¤ | âœ… å®Œæˆ |
| 2025-12-04 | ç¼–å†™æµ‹è¯•è„šæœ¬ | âœ… å®Œæˆ |
| 2025-12-04 | ç¼–å†™å®Œæ•´READMEæ–‡æ¡£ | âœ… å®Œæˆ |

---


## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- [Linux man pages online](https://man7.org/linux/man-pages/)
- [POSIX Threads (pthreads)](https://man7.org/linux/man-pages/man7/pthreads.7.html)
- [Socket API](https://man7.org/linux/man-pages/man2/socket.2.html)

### ç½‘ç»œç¼–ç¨‹ä¹¦ç±
- ã€ŠUnixç½‘ç»œç¼–ç¨‹ å·1ï¼šå¥—æ¥å­—è”ç½‘APIã€‹ - W.Richard Stevens
- ã€ŠLinux Cç¼–ç¨‹ä¸€ç«™å¼å­¦ä¹ ã€‹ - å®‹åŠ²æ‰
- ã€Šç½‘ç»œç¼–ç¨‹å®æˆ˜ã€‹ - ã€ŠLinux ç¼–ç¨‹æ‰‹å†Œã€‹

### å­¦ä¹ èµ„æº
- [Linux Kernel Documentation](https://www.kernel.org/doc/)
- [GNU C Library](https://www.gnu.org/software/libc/manual/)
- [Stack Overflow - socket tags](https://stackoverflow.com/questions/tagged/socket)

---

## ğŸ”— ç›¸å…³ç³»ç»Ÿè°ƒç”¨

### Socket ç›¸å…³
- `socket()` - åˆ›å»ºå¥—æ¥å­—
- `bind()` - ç»‘å®šåœ°å€
- `listen()` - å¼€å§‹ç›‘å¬
- `accept()` - æ¥å—è¿æ¥
- `connect()` - è¿æ¥åˆ°æœåŠ¡å™¨
- `send()` - å‘é€æ•°æ®
- `recv()` - æ¥æ”¶æ•°æ®
- `close()` - å…³é—­å¥—æ¥å­—
- `setsockopt()` - è®¾ç½®å¥—æ¥å­—é€‰é¡¹

### çº¿ç¨‹ç›¸å…³
- `pthread_create()` - åˆ›å»ºçº¿ç¨‹
- `pthread_join()` - ç­‰å¾…çº¿ç¨‹ç»“æŸ
- `pthread_detach()` - åˆ†ç¦»çº¿ç¨‹
- `pthread_exit()` - çº¿ç¨‹é€€å‡º
- `pthread_mutex_init()` - åˆå§‹åŒ–äº’æ–¥é”
- `pthread_mutex_lock()` - åŠ é”
- `pthread_mutex_unlock()` - è§£é”
- `pthread_mutex_destroy()` - é”€æ¯äº’æ–¥é”

### å…¶ä»–
- `perror()` - æ‰“å°é”™è¯¯ä¿¡æ¯
- `memset()` - å†…å­˜æ¸…é›¶
- `strlen()` - å­—ç¬¦ä¸²é•¿åº¦
- `strncpy()` - å­—ç¬¦ä¸²å¤åˆ¶

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é”™è¯¯æ£€æŸ¥
```c
// âœ… å¥½çš„åšæ³•
if (socket_fd < 0) {
    perror("socket");
    return -1;
}

// âŒ ä¸å¥½çš„åšæ³•
int socket_fd = socket(...);
// ä¸æ£€æŸ¥è¿”å›å€¼
```

### 2. èµ„æºæ¸…ç†
```c
// âœ… å¥½çš„åšæ³• - ä½¿ç”¨æ¸…ç†æ ˆï¼ˆcleanup handlerï¼‰
pthread_cleanup_push(cleanup, arg);
// ... æ‰§è¡Œæ“ä½œ ...
pthread_cleanup_pop(1);

// âœ… ç¡®ä¿å…³é—­å¥—æ¥å­—
close(sockfd);
```

### 3. çº¿ç¨‹å®‰å…¨
```c
// âœ… å¥½çš„åšæ³• - æ‰€æœ‰è®¿é—®éƒ½è¢«ä¿æŠ¤
pthread_mutex_lock(&mutex);
// ... è®¿é—®å…±äº«æ•°æ® ...
pthread_mutex_unlock(&mutex);

// âŒ ä¸å¥½çš„åšæ³• - ç«æ€æ¡ä»¶
client_count++;  // ä¸å®‰å…¨
```

### 4. ç¼“å†²åŒºå®‰å…¨
```c
// âœ… å¥½çš„åšæ³• - æŒ‡å®šæœ€å¤§é•¿åº¦
fgets(buffer, sizeof(buffer), stdin);
strncpy(dest, src, sizeof(dest) - 1);

// âŒ ä¸å¥½çš„åšæ³• - ç¼“å†²åŒºæº¢å‡º
scanf("%s", buffer);  // å±é™©
strcpy(dest, src);    // å±é™©
```

---

## ğŸ§ª æµ‹è¯•æ¸…å•

- [x] æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ
- [x] æœåŠ¡å™¨æ­£ç¡®ç»‘å®šåˆ°ç«¯å£ 8088
- [x] æœåŠ¡å™¨æ¥å—å®¢æˆ·ç«¯è¿æ¥
- [x] å®¢æˆ·ç«¯æˆåŠŸè¿æ¥
- [x] ç”¨æˆ·åå‘é€æ­£ç¡®
- [x] è¿›å…¥èŠå¤©å®¤æ¶ˆæ¯å¹¿æ’­
- [x] èŠå¤©æ¶ˆæ¯å¹¿æ’­ç»™æ‰€æœ‰å®¢æˆ·ç«¯
- [x] å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥
- [x] å®¢æˆ·ç«¯æ­£å¸¸æ–­å¼€
- [x] é€€å‡ºèŠå¤©å®¤æ¶ˆæ¯å¹¿æ’­
- [x] å¼‚å¸¸æ–­å¼€è‡ªåŠ¨æ¸…ç†
- [x] ç«¯å£å ç”¨é”™è¯¯å¤„ç†

---
